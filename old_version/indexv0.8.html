<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Repo Library — Admin + Preview</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui", "-apple-system", "Segoe UI", "Roboto", "Noto Sans", "Ubuntu", "Cantarell", "Helvetica Neue", "Arial", "\"Apple Color Emoji\"", "\"Segoe UI Emoji\"", "\"Segoe UI Symbol\""] },
          boxShadow: { soft: "0 10px 30px rgba(0,0,0,0.08)" },
        },
      },
    };
  </script>
  <!-- React UMD + Babel (for single-file JSX) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Fuse.js for powerful search -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
  <!-- highlight.js for code/text display -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    html, body, #root { height: 100%; }
    .scrollbar-thin::-webkit-scrollbar { height: 8px; width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 999px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root" class="min-h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    /**
     * =========================
     * Minimal single-file SPA for a GitHub‑hosted library
     * Modes: Admin (upload & manage) / Preview (browse & search)
     * Files stored in a GitHub repo; metadata in /data/index.json.
     * =========================
     */

    // ------------------ Utilities ------------------
    const fmtDate = (ts) => new Date(ts).toISOString().split('T')[0];
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    const FILE_KINDS = {
      pdf: { label: 'PDF', color: 'bg-red-100 text-red-700', icon: pdfIcon },
      html: { label: 'HTML', color: 'bg-orange-100 text-orange-700', icon: htmlIcon },
      text: { label: 'TEXT', color: 'bg-blue-100 text-blue-700', icon: textIcon },
      code: { label: 'CODE', color: 'bg-violet-100 text-violet-700', icon: codeIcon },
      other: { label: 'FILE', color: 'bg-slate-100 text-slate-700', icon: fileIcon },
    };

    const EXT_KIND = {
      pdf: 'pdf',
      html: 'html', htm: 'html',
      txt: 'text', md: 'text', rtf: 'text', log: 'text',
      py: 'code', js: 'code', ts: 'code', ipynb: 'code', sh: 'code', bash: 'code', c: 'code', cpp: 'code', cc: 'code', h: 'code', hpp: 'code', java: 'code', rs: 'code', go: 'code', rb: 'code', php: 'code', m: 'code', jl: 'code', tex: 'code', css: 'code', json: 'code', yml: 'code', yaml: 'code'
    };

    function extOf(name) {
      const m = name.toLowerCase().match(/\.([a-z0-9]+)$/);
      return m ? m[1] : '';
    }

    function guessKind(filename, override) {
      if (override) return override;
      const ext = extOf(filename);
      return EXT_KIND[ext] || 'other';
    }

    function b64EncodeUint8(arr) {
      // Base64 encode Uint8Array
      let binary = '';
      const len = arr.byteLength;
      for (let i = 0; i < len; i++) binary += String.fromCharCode(arr[i]);
      return btoa(binary);
    }

    // ------------------ GitHub API ------------------
    function ghRawUrl({ owner, repo, branch, path }) {
      return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
    }

    async function ghGetJSONRaw(cfg, path) {
      const res = await fetch(ghRawUrl({ ...cfg, path }));
      if (!res.ok) return null;
      return await res.json();
    }

    async function ghGetTextRaw(cfg, path) {
      const res = await fetch(ghRawUrl({ ...cfg, path }));
      if (!res.ok) return null;
      return await res.text();
    }

    async function ghGetBlobRaw(cfg, path) {
      const res = await fetch(ghRawUrl({ ...cfg, path }));
      if (!res.ok) return null;
      return await res.blob();
    }

    async function ghGetContentMeta(cfg, path, token) {
      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}?ref=${cfg.branch}`;
      const res = await fetch(url, { headers: token ? { Authorization: `token ${token}` } : {} });
      if (res.status === 404) return null;
      if (!res.ok) throw new Error('GitHub API error: ' + res.status);
      return await res.json(); // contains sha, download_url, etc.
    }

    async function ghPutContent(cfg, path, contentBase64, message, token, sha = undefined) {
      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
      const body = { message, content: contentBase64, branch: cfg.branch };
      if (sha) body.sha = sha;
      const res = await fetch(url, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `token ${token}`,
        },
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error('Failed to upload: ' + res.status + ' ' + txt);
      }
      return await res.json();
    }

    // Delete a file from the repo
    async function ghDeleteContent(cfg, path, message, token, sha) {
      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
      const res = await fetch(url, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `token ${token}`,
        },
        body: JSON.stringify({ message, branch: cfg.branch, sha }),
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error('Failed to delete: ' + res.status + ' ' + txt);
      }
      return await res.json();
    }

    // Update index.json helper
    async function updateIndex(cfg, token, updater) {
      let indexData = await ghGetJSONRaw(cfg, cfg.indexPath);
      if (!indexData) indexData = { items: [] };
      const indexMeta = await ghGetContentMeta(cfg, cfg.indexPath, token);
      const sha = indexMeta?.sha;
      const newData = await updater(indexData);
      const enc = new TextEncoder().encode(JSON.stringify(newData, null, 2));
      const b64 = b64EncodeUint8(new Uint8Array(enc));
      await ghPutContent(cfg, cfg.indexPath, b64, `Update index.json`, token, sha);
      return true;
    }

    // ------------------ Icons ------------------
    function PDFBadge() { return <span className="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700">PDF</span>; }
    function pdfIcon(props){ return (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={props.className || "w-5 h-5"}>
        <path strokeWidth="1.5" d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"/>
        <path strokeWidth="1.5" d="M14 3v5h5"/>
        <text x="9" y="17" fontSize="6" fontWeight="700">PDF</text>
      </svg>
    ); }
    function htmlIcon(props){ return (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={props.className || "w-5 h-5"}>
        <path strokeWidth="1.5" d="M3 4h18v16H3z"/>
        <path strokeWidth="1.5" d="M7 8h10M7 12h10M7 16h6"/>
      </svg>
    ); }
    function textIcon(props){ return (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={props.className || "w-5 h-5"}>
        <path strokeWidth="1.5" d="M6 4h12v16H6z"/>
        <path strokeWidth="1.5" d="M8 8h8M8 12h8M8 16h8"/>
      </svg>
    ); }
    function codeIcon(props){ return (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={props.className || "w-5 h-5"}>
        <path strokeWidth="1.5" d="M9 18l-6-6 6-6M15 6l6 6-6 6"/>
      </svg>
    ); }
    function fileIcon(props){ return (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={props.className || "w-5 h-5"}>
        <path strokeWidth="1.5" d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"/>
        <path strokeWidth="1.5" d="M14 3v5h5"/>
      </svg>
    ); }
    function searchIcon(props){ return (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={props.className || "w-5 h-5"}>
        <circle cx="11" cy="11" r="7" strokeWidth="1.5"/>
        <path d="M20 20l-3.5-3.5" strokeWidth="1.5"/>
      </svg>
    ); }
    function settingsIcon(props){ return (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={props.className || "w-5 h-5"}>
        <path strokeWidth="1.5" d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/>
        <path strokeWidth="1.5" d="M2 12h2M20 12h2M12 2v2M12 20v2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M19.1 4.9l-1.4 1.4M6.3 17.7l-1.4 1.4"/>
      </svg>
    ); }

    // ------------------ Local Storage Config ------------------
    const DEFAULT_CFG = {
      owner: 'YOUR_GITHUB_USERNAME',
      repo: 'YOUR_REPO_NAME',
      branch: 'main',
      dataDir: 'uploads',  // where files live
      indexPath: 'data/index.json',
    };

    function loadCfg() {
      try {
        const s = localStorage.getItem('repoLibrary.cfg');
        return s ? JSON.parse(s) : DEFAULT_CFG;
      } catch {
        return DEFAULT_CFG;
      }
    }
    function saveCfg(cfg) { localStorage.setItem('repoLibrary.cfg', JSON.stringify(cfg)); }

    function loadToken() {
      return localStorage.getItem('repoLibrary.token') || '';
    }
    function saveToken(t) {
      if (!t) localStorage.removeItem('repoLibrary.token');
      else localStorage.setItem('repoLibrary.token', t);
    }

    // ------------------ Main App ------------------
    function App(){
      const [cfg, setCfg] = useState(loadCfg());
      const [token, setToken] = useState(loadToken());
      const [mode, setMode] = useState(token ? 'admin' : 'preview');
      const [entries, setEntries] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [query, setQuery] = useState('');
      const [sortBy, setSortBy] = useState('time_desc');
      const [activeTag, setActiveTag] = useState('');
      const [activeTopic, setActiveTopic] = useState('');
      const [viewerItem, setViewerItem] = useState(null);
      const [editingItem, setEditingItem] = useState(null);

      useEffect(() => { (async () => {
        setLoading(true); setError('');
        try {
          const data = await ghGetJSONRaw(cfg, cfg.indexPath);
          if (data && Array.isArray(data.items)) setEntries(data.items);
          else setEntries([]);
        } catch(e){ setError(e.message); }
        setLoading(false);
      })(); }, [cfg.owner, cfg.repo, cfg.branch, cfg.indexPath]);

      const allTopics = useMemo(() => Array.from(new Set(entries.map(e => e.topic).filter(Boolean))).sort(), [entries]);
      const allTags = useMemo(() => Array.from(new Set(entries.flatMap(e => e.tags || [])).values()).sort((a,b)=>a.localeCompare(b)), [entries]);

      const fuse = useMemo(() => new Fuse(entries, {
        keys: [ { name: 'title', weight: 0.6 }, { name: 'filename', weight: 0.2 }, { name: 'topic', weight: 0.15 }, { name: 'tags', weight: 0.25 } ],
        threshold: 0.35, includeScore: true, ignoreLocation: true,
      }), [entries]);

      const filtered = useMemo(() => {
        let list = entries;
        if (activeTopic) list = list.filter(e => e.topic === activeTopic);
        if (activeTag) list = list.filter(e => (e.tags||[]).includes(activeTag));
        if (query.trim()) list = fuse.search(query.trim()).map(r => r.item);
        switch (sortBy) {
          case 'time_desc': list = [...list].sort((a,b)=> (b.ts||0) - (a.ts||0)); break;
          case 'time_asc': list = [...list].sort((a,b)=> (a.ts||0) - (b.ts||0)); break;
          case 'title_asc': list = [...list].sort((a,b)=> (a.title||'').localeCompare(b.title||'')); break;
          case 'title_desc': list = [...list].sort((a,b)=> (b.title||'').localeCompare(a.title||'')); break;
          case 'type': list = [...list].sort((a,b)=> (a.kind||'').localeCompare(b.kind||'')); break;
        }
        return list;
      }, [entries, activeTopic, activeTag, query, sortBy, fuse]);

      async function refreshIndex(){
        try { const data = await ghGetJSONRaw(cfg, cfg.indexPath); if (data && Array.isArray(data.items)) setEntries(data.items); }
        catch(e){ console.warn('Failed to refresh index:', e); }
      }

      function onSaveCfg(newCfg){ setCfg(newCfg); saveCfg(newCfg); }
      function onSaveToken(t){ setToken(t); saveToken(t); setMode(t ? 'admin' : 'preview'); }

      function goHome(){ setQuery(''); setSortBy('time_desc'); setActiveTag(''); setActiveTopic(''); setMode('preview'); setViewerItem(null); setEditingItem(null); }

      async function handleDeleteItem(item){
        if (!token) return alert('需要管理员令牌');
        if (!confirm(`确认删除：${item.title || item.filename} ?`)) return;
        try {
          // delete main file
          const meta = await ghGetContentMeta(cfg, item.path, token);
          if (meta?.sha) await ghDeleteContent(cfg, item.path, `Delete ${item.filename}`, token, meta.sha);
          // delete cover if any (best-effort)
          if (item.imagePath) {
            try { const m2 = await ghGetContentMeta(cfg, item.imagePath, token); if (m2?.sha) await ghDeleteContent(cfg, item.imagePath, `Delete cover for ${item.filename}`, token, m2.sha); } catch(e){}
          }
          // update index
          await updateIndex(cfg, token, data => ({ ...data, items: (data.items||[]).filter(x => x.id !== item.id) }));
          await refreshIndex();
        } catch(e) { alert('删除失败：' + e.message); }
      }

      async function handleSaveEdit(updated, newCoverFile){
        if (!token) return alert('需要管理员令牌');
        try {
          let imagePath = updated.imagePath || '';
          if (newCoverFile) {
            const y = new Date().getFullYear();
            const m = String(new Date().getMonth()+1).padStart(2,'0');
            const baseDir = `${cfg.dataDir}/${y}/${m}`;
            const buf = new Uint8Array(await newCoverFile.arrayBuffer());
            const b64 = b64EncodeUint8(buf);
            const imgName = `${uid()}__${newCoverFile.name}`;
            imagePath = `${baseDir}/images/${imgName}`;
            const meta = await ghGetContentMeta(cfg, imagePath, token);
            await ghPutContent(cfg, imagePath, b64, `Upload cover ${newCoverFile.name}`, token, meta?.sha);
          }
          const newItem = { ...updated, imagePath };
          await updateIndex(cfg, token, data => ({ ...data, items: (data.items||[]).map(x => x.id===newItem.id? newItem : x) }));
          setEditingItem(null);
          await refreshIndex();
        } catch(e) { alert('保存失败：' + e.message); }
      }

      return (
        <div className="min-h-full flex flex-col">
          <Header mode={mode} setMode={setMode} query={query} setQuery={setQuery} cfg={cfg} setCfg={onSaveCfg} token={token} setToken={onSaveToken} onHome={goHome} />

          <main className="max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">
            {mode === 'admin' ? (
              <AdminPanelV2 cfg={cfg} token={token} onUploaded={refreshIndex} />
            ) : null}

            <PreviewPanel
              cfg={cfg}
              mode={mode}
              loading={loading}
              error={error}
              items={filtered}
              allTopics={allTopics}
              allTags={allTags}
              activeTopic={activeTopic}
              setActiveTopic={setActiveTopic}
              activeTag={activeTag}
              setActiveTag={setActiveTag}
              sortBy={sortBy}
              setSortBy={setSortBy}
              onOpen={setViewerItem}
              onEdit={setEditingItem}
              onDeleted={handleDeleteItem}
            />
          </main>

          <Footer />

          {editingItem ? (
            <EditItemModal cfg={cfg} item={editingItem} onClose={()=>setEditingItem(null)} onSave={handleSaveEdit} />
          ) : null}

          {viewerItem ? (
            <ViewerModal cfg={cfg} item={viewerItem} onClose={()=>setViewerItem(null)} />
          ) : null}
        </div>
      );
    }

    // ------------------ Header ------------------
    function Header({ mode, setMode, query, setQuery, cfg, setCfg, token, setToken, onHome }){
      const [openCfg, setOpenCfg] = useState(false);
      return (
        <header className="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-700 text-white">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center gap-3">
            <a href="#" onClick={(e)=>{e.preventDefault(); onHome && onHome();}} className="flex items-center gap-2 hover:opacity-90 group">
              <div className="w-8 h-8 rounded-xl bg-white/10 flex items-center justify-center ring-1 ring-white/20">
                <fileIcon className="w-5 h-5" />
              </div>
              <div className="text-lg font-semibold underline decoration-dotted decoration-white/40 group-hover:decoration-white">Repo Library</div>
            </a>
            <div className="flex-1" />
            <div className="relative w-full max-w-xl">
              <div className="absolute left-3 top-2.5 text-white/60"><searchIcon /></div>
              <input value={query} onChange={(e)=>setQuery(e.target.value)} placeholder="全局搜索: 标题 / 话题 / 标签 / 文件名"
                     className="w-full pl-10 pr-3 py-2 rounded-xl bg-white/10 backdrop-blur text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/40" />
            </div>
            <div className="flex items-center gap-2">
              {token ? (
                <button onClick={()=>setMode(mode==='admin'?'preview':'admin')}
                        className="px-3 py-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20 transition">
                  {mode==='admin' ? '切换到预览' : '切换到管理'}
                </button>
              ) : null}
              <button onClick={()=>setOpenCfg(true)} className="p-2 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20 transition"><settingsIcon/></button>
            </div>
          </div>
          {openCfg ? (
            <div className="bg-slate-900/80 border-t border-white/10">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <ConfigPanel cfg={cfg} setCfg={setCfg} token={token} setToken={setToken} />
              </div>
            </div>
          ) : null}
        </header>
      );
    }

    function ConfigPanel({ cfg, setCfg, token, setToken }){
      const [localCfg, setLocalCfg] = useState(cfg);
      const [localToken, setLocalToken] = useState(token);
      return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="bg-white/5 rounded-2xl p-4 border border-white/10">
            <div className="font-semibold mb-3">GitHub 仓库设置</div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <LabeledInput label="Owner" value={localCfg.owner} onChange={v=>setLocalCfg({...localCfg, owner:v})} />
              <LabeledInput label="Repo" value={localCfg.repo} onChange={v=>setLocalCfg({...localCfg, repo:v})} />
              <LabeledInput label="Branch" value={localCfg.branch} onChange={v=>setLocalCfg({...localCfg, branch:v})} />
              <LabeledInput label="数据目录 (files)" value={localCfg.dataDir} onChange={v=>setLocalCfg({...localCfg, dataDir:v})} />
              <LabeledInput label="索引文件路径" value={localCfg.indexPath} onChange={v=>setLocalCfg({...localCfg, indexPath:v})} />
            </div>
            <div className="mt-3 flex gap-2">
              <button onClick={()=>setCfg(localCfg)} className="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700">保存配置</button>
              <a className="px-4 py-2 rounded-xl bg-slate-600 hover:bg-slate-700" target="_blank" rel="noreferrer" href={`https://github.com/${localCfg.owner}/${localCfg.repo}`}>打开仓库</a>
            </div>
          </div>
          <div className="bg-white/5 rounded-2xl p-4 border border-white/10">
            <div className="font-semibold mb-3">管理员令牌 (Personal Access Token)</div>
            <p className="text-sm text-white/70 mb-2">需要 <code>repo</code> 或 <code>public_repo</code> 权限。令牌将只保存在本机浏览器的 LocalStorage。</p>
            <input type="password" className="w-full px-3 py-2 rounded-xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:outline-none"
                   placeholder="ghp_xxx..." value={localToken} onChange={(e)=>setLocalToken(e.target.value)} />
            <div className="mt-3 flex gap-2">
              <button onClick={()=>setToken(localToken)} className="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700">保存令牌</button>
              <button onClick={(e)=>{ navigator.clipboard.writeText(text||''); const btn=e.currentTarget; const old=btn.innerText; btn.innerText='已复制 ✓'; setTimeout(()=>btn.innerText=old,1200); }} className="px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">复制</button>
                ) : null}
                <button onClick={onClose} className="px-3 py-1.5 rounded-lg bg-slate-900 text-white hover:bg-slate-800">关闭</button>
              </div>
            </div>

            <div className="p-3 bg-slate-50 border-b border-slate-200 flex items-center gap-2 text-sm">
              <span className="text-slate-600">渲染为:</span>
              <div className="flex gap-2">
                <button onClick={()=>setMode('pdf')} disabled={item.kind!=='pdf'} className={`px-3 py-1.5 rounded-lg border ${mode==='pdf'?'bg-slate-900 text-white border-slate-900':'bg-white border-slate-300 text-slate-700'} ${item.kind!=='pdf'?'opacity-50 cursor-not-allowed':''}`}>PDF</button>
                <button onClick={()=>setMode('html')} disabled={item.kind!=='html'} className={`px-3 py-1.5 rounded-lg border ${mode==='html'?'bg-slate-900 text-white border-slate-900':'bg-white border-slate-300 text-slate-700'} ${item.kind!=='html'?'opacity-50 cursor-not-allowed':''}`}>HTML</button>
                <button onClick={()=>setMode(item.kind==='code'?'code':'text')} disabled={!(item.kind==='text' || item.kind==='code')} className={`px-3 py-1.5 rounded-lg border ${mode==='text' || mode==='code'?'bg-slate-900 text-white border-slate-900':'bg-white border-slate-300 text-slate-700'} ${!(item.kind==='text' || item.kind==='code')?'opacity-50 cursor-not-allowed':''}`}>{item.kind==='code'?'Code':'Text'}</button>
                <a className="px-3 py-1.5 rounded-lg bg-slate-200 hover:bg-slate-300 border border-slate-300" target="_blank" rel="noreferrer" href={ghRawUrl({ owner: cfg.owner, repo: cfg.repo, branch: cfg.branch, path: item.path })}>Raw</a>
              </div>
            </div>

            <div className="p-0 max-h-[75vh] overflow-auto">
              {loading ? (
                <div className="p-6 text-slate-600">加载中…</div>
              ) : err ? (
                <div className="p-6 text-rose-600">{err}</div>
              ) : mode==='pdf' ? (
                <iframe className="w-full h-[75vh]" src={blobUrl} title="PDF Preview"></iframe>
              ) : mode==='html' ? (
                <iframe className="w-full h-[75vh] bg-white" srcDoc={text} title="HTML Preview" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
              ) : (
                <pre className="p-4 text-sm bg-[#0b1020] text-slate-50 overflow-auto"><code>{text}</code></pre>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ------------------ Edit Item Modal ------------------
    function EditItemModal({ cfg, item, onClose, onSave }){
      const [title, setTitle] = useState(item.title || '');
      const [topic, setTopic] = useState(item.topic || '');
      const [tags, setTags] = useState((item.tags||[]).join(', '));
      const [desc, setDesc] = useState(item.desc || '');
      const [cover, setCover] = useState(null);
      const rawCover = item.imagePath ? ghRawUrl({ owner: cfg.owner, repo: cfg.repo, branch: cfg.branch, path: item.imagePath }) : '';

      function handleSubmit(){
        const updated = { ...item, title, topic, tags: tags.split(',').map(s=>s.trim()).filter(Boolean), desc };
        onSave && onSave(updated, cover);
      }

      return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className="bg-white max-w-3xl w-full rounded-3xl overflow-hidden border border-slate-200 shadow-2xl" onClick={e=>e.stopPropagation()}>
            <div className="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
              <div className="font-semibold">编辑条目</div>
              <button onClick={onClose} className="px-3 py-1.5 rounded-lg bg-slate-900 text-white hover:bg-slate-800">关闭</button>
            </div>
            <div className="p-4 grid grid-cols-1 gap-4">
              <label className="text-sm">
                <div className="mb-1 text-slate-700">标题</div>
                <input value={title} onChange={e=>setTitle(e.target.value)} className="w-full px-3 py-2 rounded-xl border border-slate-300" />
              </label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label className="text-sm">
                  <div className="mb-1 text-slate-700">Topic</div>
                  <input value={topic} onChange={e=>setTopic(e.target.value)} className="w-full px-3 py-2 rounded-xl border border-slate-300" />
                </label>
                <label className="text-sm">
                  <div className="mb-1 text-slate-700">Tags（逗号分隔）</div>
                  <input value={tags} onChange={e=>setTags(e.target.value)} className="w-full px-3 py-2 rounded-xl border border-slate-300" />
                </label>
              </div>
              <label className="text-sm">
                <div className="mb-1 text-slate-700">简要描述</div>
                <textarea value={desc} onChange={e=>setDesc(e.target.value)} rows={4} className="w-full px-3 py-2 rounded-xl border border-slate-300" />
              </label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div>
                  <div className="mb-1 text-slate-700 text-sm">封面图（可选，上传新图将覆盖旧图）</div>
                  <input type="file" accept="image/*" onChange={(e)=>setCover((e.target.files||[])[0]||null)} className="w-full px-3 py-2 rounded-xl border border-slate-300" />
                </div>
                <div>
                  <div className="mb-1 text-slate-700 text-sm">当前封面</div>
                  <div className="w-full h-36 rounded-xl overflow-hidden bg-slate-100 flex items-center justify-center">
                    {rawCover ? <img src={rawCover} className="w-full h-full object-cover"/> : <div className="text-slate-400 text-sm">无封面</div>}
                  </div>
                </div>
              </div>
              <div className="pt-2 flex items-center gap-2">
                <button onClick={handleSubmit} className="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">保存</button>
                <a target="_blank" rel="noreferrer" href={ghRawUrl({ owner: cfg.owner, repo: cfg.repo, branch: cfg.branch, path: item.path })} className="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">打开原文件</a>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ------------------ Footer ------------------
    function Footer(){
      return (
        <footer className="py-6 text-center text-sm text-slate-500">
          <div>© {new Date().getFullYear()} Repo Library. · 以 GitHub 作为存储与托管 · 单文件网页</div>
        </footer>
      );
    }

    // Expose cfg to window for Card raw link (so it always uses latest)
    window.__cfg = loadCfg();

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>

  <!--
  ===================== 部署与使用说明（简版） =====================
  1) 新建或选择一个 GitHub 仓库（建议公开 repo 便于直接原始链接）。在 Settings → Pages 启用 GitHub Pages。
  2) 将本 index.html 放进仓库根目录（或 docs/，同时在 Pages 里选中），提交。
  3) 打开 GitHub Pages 页面（如 https://<user>.github.io/<repo>/ ）。
  4) 顶部齿轮进入“仓库设置”，填入 Owner、Repo、Branch、数据目录(uploads)、索引路径(data/index.json)。保存。
  5) 在同一面板中粘贴你的个人访问令牌（PAT），至少需要 public_repo（公开库）或 repo（私库）权限。令牌仅保存在你的浏览器 LocalStorage。
  6) 切换到“管理者模式”，选择文件，填写可选的 Title/Topic/Tags，然后“开始上传”。
     - 文件会被上传至 uploads/YYYY/MM/ 目录下，索引会写入 data/index.json。
  7) 预览模式：支持按时间/标题/类型排序，按 Topic/Tag 过滤，顶部搜索框为全局模糊搜索（Fuse.js）。
  8) 点击卡片“预览”即可在弹窗中查看：
     - PDF 以浏览器内置查看器（通过 Blob URL）显示。
     - HTML 以 iframe sandbox 的 srcdoc 安全渲染。
     - 文本/代码以等宽字体显示，集成 highlight.js（自动高亮常见语言）。

  注意：
  - PAT 保存在本地浏览器，谨慎使用公共电脑。你可随时在配置面板“清除”。
  - 该方案使用 GitHub Contents API 单文件提交与索引更新，简洁可靠；如需一次性多文件同一提交，可后续改为 Git 数据树 API。
  - 若希望全文检索 PDF 内容，可在后续加入 pdf.js 文本抽取逻辑，并在索引中缓存摘要，避免每次重抓 PDF。
  - 若你的仓库为私有，在预览模式访问原始文件将需要具备访问权限的浏览器环境（或改为通过 API 代理）。
  =============================================================
  -->
</body>
</html>
