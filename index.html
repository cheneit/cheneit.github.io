<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Repo Library â€” Admin + Preview</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui", "-apple-system", "Segoe UI", "Roboto", "Noto Sans", "Ubuntu", "Cantarell", "Helvetica Neue", "Arial", "\"Apple Color Emoji\"", "\"Segoe UI Emoji\"", "\"Segoe UI Symbol\""] },
          boxShadow: { soft: "0 10px 30px rgba(0,0,0,0.08)" },
        },
      },
    };
  </script>
  <!-- React UMD + Babel (for single-file JSX) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Fuse.js for powerful search -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
  <!-- highlight.js for code/text display -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    html, body, #root { height: 100%; }
    .scrollbar-thin::-webkit-scrollbar { height: 8px; width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 999px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root" class="min-h-full"></div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    /**
     * =========================
     * Single-file SPA for a GitHub-hosted library
     * Modes: Admin (upload & manage) / Preview (browse & search)
     * Files stored in a GitHub repo; metadata in /data/index.json.
     * =========================
     */

    // -------- ç®€å•å¯†ç ä¿æŠ¤é…ç½®ï¼ˆå‰ç«¯é˜²å›å­ï¼Œä¸æ˜¯ç»å¯¹å®‰å…¨ï¼‰ --------
    // è¯·æŠŠ PASSWORD_HASH æ›¿æ¢æˆä½ è‡ªå·±çš„å¯†ç çš„ SHA-256 åå…­è¿›åˆ¶å­—ç¬¦ä¸²
    const PASSWORD_HASH = '6543cc38c0864d19a15351545d60e99307b9cef4d9c2c21c225735744ea00762';
    const AUTH_KEY = 'repoLibrary.authed';

    async function sha256Hex(str) {
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    // ------------------ Utilities ------------------
    const fmtDate = (ts) => new Date(ts).toISOString().split('T')[0];
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    const FILE_KINDS = {
      pdf: { label: 'PDF', color: 'bg-red-100 text-red-700', icon: pdfIcon },
      html: { label: 'HTML', color: 'bg-orange-100 text-orange-700', icon: htmlIcon },
      text: { label: 'TEXT', color: 'bg-blue-100 text-blue-700', icon: textIcon },
      code: { label: 'CODE', color: 'bg-emerald-100 text-emerald-700', icon: codeIcon },
      other: { label: 'FILE', color: 'bg-slate-100 text-slate-700', icon: fileIcon }
    };

    const EXT_KIND = {
      pdf: 'pdf',
      html: 'html', htm: 'html',
      txt: 'text', md: 'text', rtf: 'text', log: 'text',
      py: 'code', js: 'code', ts: 'code', ipynb: 'code', sh: 'code', c: 'code', cpp: 'code',
      cu: 'code', f90: 'code', f: 'code', jl: 'code', m: 'code', rs: 'code',
      tex: 'code', css: 'code', json: 'code', yml: 'code', yaml: 'code'
    };

    function extOf(name) {
      const m = name.toLowerCase().match(/\.([a-z0-9]+)$/);
      return m ? m[1] : '';
    }

    function guessKind(filename, override) {
      if (override) return override;
      const ext = extOf(filename);
      return EXT_KIND[ext] || 'other';
    }

    function guessHighlightLanguage(filename) {
      const ext = extOf(filename || '');
      switch (ext) {
        case 'py': return 'python';
        case 'js':
        case 'jsx': return 'javascript';
        case 'ts':
        case 'tsx': return 'typescript';
        case 'sh':
        case 'bash': return 'bash';
        case 'json': return 'json';
        case 'html':
        case 'htm': return 'xml';
        case 'css': return 'css';
        case 'c': return 'c';
        case 'cpp':
        case 'cc':
        case 'cxx':
        case 'h':
        case 'hpp': return 'cpp';
        case 'java': return 'java';
        case 'rb': return 'ruby';
        case 'go': return 'go';
        case 'rs':
        case 'rust': return 'rust';
        default: return '';
      }
    }

    function b64EncodeUint8(arr) {
      let binary = '';
      const len = arr.byteLength;
      for (let i = 0; i < len; i++) binary += String.fromCharCode(arr[i]);
      return btoa(binary);
    }

    function b64DecodeToUint8(b64) {
      const binary = atob(b64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
      return bytes;
    }

    // ------------------ GitHub helpers ------------------
    function ghApiUrl({ owner, repo, path }) {
      return `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    }

    function ghRawUrl({ owner, repo, branch, path }) {
      return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
    }

    function isAbsoluteUrl(path) {
      return /^https?:\/\//.test(path || '');
    }

    function buildRawUrl(cfg, path) {
      if (!path) return '#';
      if (isAbsoluteUrl(path)) return path;
      return ghRawUrl({ owner: cfg.owner, repo: cfg.repo, branch: cfg.branch, path });
    }

    async function ghGetJSONRaw(cfg, path) {
      const url = buildRawUrl(cfg, path);
      const res = await fetch(url);
      if (!res.ok) return null;
      return await res.json();
    }

    async function ghGetTextRaw(cfg, path) {
      const url = buildRawUrl(cfg, path);
      const res = await fetch(url);
      if (!res.ok) return null;
      return await res.text();
    }

    async function ghGetBlobRaw(cfg, path) {
      const url = buildRawUrl(cfg, path);
      const res = await fetch(url);
      if (!res.ok) return null;
      return await res.blob();
    }

    async function ghGetContentMeta(cfg, path, token) {
      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${path}`;
      const res = await fetch(url, {
        headers: token ? { Authorization: `Bearer ${token}` } : {}
      });
      if (!res.ok) return null;
      return await res.json();
    }

    async function ghPutContent(cfg, path, contentB64, message, token, sha) {
      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${path}`;
      const body = { message, content: contentB64 };
      if (sha) body.sha = sha;
      const res = await fetch(url, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { Authorization: `Bearer ${token}` } : {})
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`PUT failed: ${res.status} ${res.statusText} - ${txt}`);
      }
      return res.json();
    }

    async function ghDeleteContent(cfg, path, message, token, sha) {
      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${path}`;
      const body = { message, sha };
      const res = await fetch(url, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { Authorization: `Bearer ${token}` } : {})
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`DELETE failed: ${res.status} ${res.statusText} - ${txt}`);
      }
      return res.json();
    }

    async function updateIndex(cfg, token, updater) {
      let indexData = await ghGetJSONRaw(cfg, cfg.indexPath);
      if (!indexData) indexData = { items: [] };
      const indexMeta = await ghGetContentMeta(cfg, cfg.indexPath, token);
      const sha = indexMeta?.sha;
      const newData = await updater(indexData);
      const enc = new TextEncoder().encode(JSON.stringify(newData, null, 2));
      const b64 = b64EncodeUint8(new Uint8Array(enc));
      await ghPutContent(cfg, cfg.indexPath, b64, `Update index.json`, token, sha);
      return true;
    }

    async function uploadCoverIfNeeded(cfg, token, coverFile, existingPath) {
      if (!coverFile) return existingPath || '';
      const y = new Date().getFullYear();
      const m = String(new Date().getMonth() + 1).padStart(2, '0');
      const baseDir = `${cfg.dataDir}/${y}/${m}`;
      const buf = new Uint8Array(await coverFile.arrayBuffer());
      const b64 = b64EncodeUint8(buf);
      const imgName = `${uid()}__${coverFile.name}`;
      const imagePath = `${baseDir}/images/${imgName}`;
      const meta = await ghGetContentMeta(cfg, imagePath, token);
      await ghPutContent(cfg, imagePath, b64, `Upload cover ${coverFile.name}`, token, meta?.sha);
      return imagePath;
    }

    // ------------------ Icons ------------------
    function pdfIcon(props) { return <span {...props}>ğŸ“„</span>; }
    function htmlIcon(props) { return <span {...props}>ğŸŒ</span>; }
    function textIcon(props) { return <span {...props}>ğŸ“ƒ</span>; }
    function codeIcon(props) { return <span {...props}>ğŸ’»</span>; }
    function fileIcon(props) { return <span {...props}>ğŸ“¦</span>; }

    // ------------------ Local Storage helpers ------------------
    function loadConfig() {
      try {
        const raw = localStorage.getItem('repoLibrary.config');
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        console.error('loadConfig error', e);
        return null;
      }
    }

    function saveConfig(cfg) {
      try {
        localStorage.setItem('repoLibrary.config', JSON.stringify(cfg));
      } catch (e) {
        console.error('saveConfig error', e);
      }
    }

    function loadToken() { return localStorage.getItem('repoLibrary.token') || ''; }
    function saveToken(t) { if (!t) localStorage.removeItem('repoLibrary.token'); else localStorage.setItem('repoLibrary.token', t); }

    // ------------------ App ------------------
    function App(){
      const [cfg, setCfg] = useState(() => loadConfig() || {
        owner: 'cheneit',
        repo: 'cheneit.github.io',
        branch: 'main',
        dataDir: 'data/files',
        indexPath: 'data/index.json'
      });
      const [token, setToken] = useState(() => loadToken());
      const [mode, setMode] = useState('preview'); // 'preview' | 'admin'
      const [index, setIndex] = useState({ items: [] });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [query, setQuery] = useState('');
      const [activeTopic, setActiveTopic] = useState('');
      const [activeTag, setActiveTag] = useState('');
      const [sortBy, setSortBy] = useState('time_desc');
      const [selectedItem, setSelectedItem] = useState(null);
      const [editingItem, setEditingItem] = useState(null);

      function onSaveCfg(newCfg){
        setCfg(newCfg);
        saveConfig(newCfg);
      }
      function onSaveToken(t){
        setToken(t);
        saveToken(t);
      }

      async function refreshIndex(){
        setLoading(true); setError('');
        try {
          const data = await ghGetJSONRaw(cfg, cfg.indexPath);
          setIndex(data || { items: [] });
        } catch(e) {
          console.error(e);
          setError('æ— æ³•åŠ è½½ index.jsonï¼š' + e.message);
        } finally {
          setLoading(false);
        }
      }

      useEffect(() => { refreshIndex(); }, [cfg.owner, cfg.repo, cfg.branch, cfg.dataDir, cfg.indexPath]);

      const allItems = index.items || [];

      const topics = useMemo(() => {
        const s = new Set();
        allItems.forEach(i => { if (i.topic) s.add(i.topic); });
        return Array.from(s).sort();
      }, [allItems]);

      const allTags = useMemo(() => {
        const s = new Set();
        allItems.forEach(i => (i.tags||[]).forEach(t => s.add(t)));
        return Array.from(s).sort();
      }, [allItems]);

      const filtered = useMemo(() => {
        const q = query.trim().toLowerCase();
        let arr = [...allItems];
        if (q) {
          arr = arr.filter(i => {
            const text = [
              i.title,
              i.filename,
              i.topic,
              (i.tags||[]).join(' '),
              i.desc
            ].join(' ').toLowerCase();
            return text.includes(q);
          });
        }
        if (activeTopic) arr = arr.filter(i => i.topic === activeTopic);
        if (activeTag) arr = arr.filter(i => (i.tags||[]).includes(activeTag));

        arr.sort((a, b) => {
          if (sortBy === 'time_desc') return (b.ts||0) - (a.ts||0);
          if (sortBy === 'time_asc') return (a.ts||0) - (b.ts||0);
          if (sortBy === 'title_asc') return (a.title||a.filename||'').localeCompare(b.title||b.filename||'');
          if (sortBy === 'title_desc') return (b.title||b.filename||'').localeCompare(a.title||a.filename||'');
          if (sortBy === 'type') return (a.kind||'').localeCompare(b.kind||'');
          return 0;
        });
        return arr;
      }, [allItems, query, activeTopic, activeTag, sortBy]);

      function goHome(){
        setQuery('');
        setActiveTopic('');
        setActiveTag('');
        setSortBy('time_desc');
      }

      async function handleDeleteItem(item){
        if (!token) return alert('éœ€è¦ç®¡ç†å‘˜ä»¤ç‰Œ');
        if (!confirm(`ç¡®è®¤åˆ é™¤ï¼š${item.title || item.filename} ?`)) return;
        try {
          const itemPath = item.path || '';
          if (itemPath && !isAbsoluteUrl(itemPath)) {
            const meta = await ghGetContentMeta(cfg, itemPath, token);
            if (meta?.sha) {
              await ghDeleteContent(cfg, itemPath, `Delete ${item.filename}`, token, meta.sha);
            }
          }
          if (item.imagePath && !isAbsoluteUrl(item.imagePath)) {
            try {
              const m2 = await ghGetContentMeta(cfg, item.imagePath, token);
              if (m2?.sha) {
                await ghDeleteContent(cfg, item.imagePath, `Delete cover for ${item.filename}`, token, m2.sha);
              }
            } catch(e) {
              console.warn('åˆ é™¤å°é¢å¤±è´¥', e);
            }
          }
          await updateIndex(cfg, token, data => ({ 
            ...data, 
            items: (data.items || []).filter(x => x.id !== item.id) 
          }));
          await refreshIndex();
        } catch(e) { 
          alert('åˆ é™¤å¤±è´¥ï¼š' + e.message); 
        }
      }

      async function handleSaveEdit(updated, newCoverFile){
        if (!token) return alert('éœ€è¦ç®¡ç†å‘˜ä»¤ç‰Œ');
        try {
          const imagePath = await uploadCoverIfNeeded(cfg, token, newCoverFile, updated.imagePath || '');
          const newItem = { ...updated, imagePath };
          await updateIndex(cfg, token, data => ({ 
            ...data, 
            items: (data.items || []).map(x => x.id === newItem.id ? newItem : x) 
          }));
          setEditingItem(null);
          await refreshIndex();
        } catch(e) { 
          alert('ä¿å­˜å¤±è´¥ï¼š' + e.message); 
        }
      }

      return (
        <div className="min-h-full flex flex-col">
          <Header mode={mode} setMode={setMode} query={query} setQuery={setQuery} onSaveCfg={onSaveCfg} token={token} setToken={onSaveToken} onHome={goHome} />

          <main className="max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">
            {mode === 'admin' ? (
              <AdminPanelV2 cfg={cfg} token={token} onUploaded={refreshIndex} />
            ) : null}

            <PreviewPanel
              loading={loading}
              error={error}
              items={filtered}
              allTopics={topics}
              allTags={allTags}
              activeTopic={activeTopic}
              setActiveTopic={setActiveTopic}
              activeTag={activeTag}
              setActiveTag={setActiveTag}
              sortBy={sortBy}
              setSortBy={setSortBy}
              onOpen={setSelectedItem}
              cfg={cfg}
              mode={mode}
              onEdit={setEditingItem}
              onDeleted={handleDeleteItem}
            />
          </main>

          <Footer />

          {selectedItem ? (
            <ViewerModal cfg={cfg} item={selectedItem} onClose={() => setSelectedItem(null)} />
          ) : null}

          {editingItem ? (
            <EditItemModal cfg={cfg} item={editingItem} onClose={() => setEditingItem(null)} onSave={handleSaveEdit} />
          ) : null}
        </div>
      );
    }

    // ------------------ Header ------------------
    function Header({ mode, setMode, query, setQuery, onSaveCfg, token, setToken, onHome }){
      const [showCfg, setShowCfg] = useState(false);

      return (
        <header className="bg-slate-900 text-white">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col gap-4">
            <div className="flex items-center justify-between gap-4">
              <div className="flex items-center gap-3">
                <div className="w-9 h-9 rounded-2xl bg-slate-800 flex items-center justify-center text-lg">ğŸ“š</div>
                <div>
                  <div className="text-lg font-semibold">Repo Library</div>
                  <div className="text-xs text-slate-300">GitHub é©±åŠ¨çš„ä¸€é¡µå¼æ–‡çŒ® / ä»£ç ç®¡ç†å·¥å…·</div>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={onHome}
                  className="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-xs"
                >
                  é‡ç½®æœç´¢
                </button>
                <button
                  onClick={() => setMode('preview')}
                  className={`px-3 py-1.5 rounded-xl text-xs ${mode==='preview' ? 'bg-white text-slate-900' : 'bg-slate-800 text-slate-200'}`}
                >
                  é¢„è§ˆæ¨¡å¼
                </button>
                <button
                  onClick={() => setMode('admin')}
                  className={`px-3 py-1.5 rounded-xl text-xs ${mode==='admin' ? 'bg-amber-400 text-slate-900' : 'bg-slate-800 text-slate-200'}`}
                >
                  ç®¡ç†æ¨¡å¼
                </button>
                <button
                  onClick={() => setShowCfg(s => !s)}
                  className="px-3 py-1.5 rounded-xl text-xs bg-slate-700 hover:bg-slate-600"
                >
                  ä»“åº“è®¾ç½®
                </button>
              </div>
            </div>

            <div className="flex flex-col md:flex-row gap-3">
              <div className="flex-1">
                <input
                  value={query}
                  onChange={(e)=>setQuery(e.target.value)}
                  className="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400"
                  placeholder="æœç´¢æ ‡é¢˜ / æ–‡ä»¶å / Topic / æ ‡ç­¾ / æè¿°..."
                />
              </div>
            </div>

            {showCfg ? (
              <div className="mt-2 border border-slate-700 rounded-2xl p-3">
                <ConfigPanel cfg={loadConfig() || { owner: 'cheneit', repo: 'cheneit.github.io', branch: 'main', dataDir: 'data/files', indexPath: 'data/index.json' }} setCfg={onSaveCfg} token={token} setToken={setToken} />
              </div>
            ) : null}
          </div>
        </header>
      );
    }

    function LabeledInput({ label, value, onChange, placeholder }) {
      return (
        <label className="text-sm">
          <div className="mb-1 text-white/80">{label}</div>
          <input
            value={value}
            onChange={e=>onChange(e.target.value)}
            placeholder={placeholder}
            className="w-full px-3 py-1.5 rounded-lg bg-white/10 border border-white/20 text-xs placeholder-white/40 focus:outline-none focus:ring-1 focus:ring-amber-400"
          />
        </label>
      );
    }

    function ConfigPanel({ cfg, setCfg, token, setToken }){
      const [localCfg, setLocalCfg] = useState(cfg);
      const [localToken, setLocalToken] = useState(token);
      return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="bg-white/5 rounded-2xl p-4 border border-white/10">
            <div className="font-semibold mb-3">GitHub ä»“åº“è®¾ç½®</div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <LabeledInput label="Owner" value={localCfg.owner} onChange={v=>setLocalCfg({...localCfg, owner:v})} />
              <LabeledInput label="Repo" value={localCfg.repo} onChange={v=>setLocalCfg({...localCfg, repo:v})} />
              <LabeledInput label="Branch" value={localCfg.branch} onChange={v=>setLocalCfg({...localCfg, branch:v})} />
              <LabeledInput label="æ•°æ®ç›®å½• (files)" value={localCfg.dataDir} onChange={v=>setLocalCfg({...localCfg, dataDir:v})} />
              <LabeledInput label="ç´¢å¼•æ–‡ä»¶è·¯å¾„" value={localCfg.indexPath} onChange={v=>setLocalCfg({...localCfg, indexPath:v})} />
            </div>
            <div className="mt-3 flex gap-2">
              <button onClick={()=>setCfg(localCfg)} className="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-sm">ä¿å­˜é…ç½®</button>
              <a className="px-4 py-2 rounded-xl bg-slate-600 hover:bg-slate-500 text-sm" target="_blank" rel="noreferrer"
                 href={`https://github.com/${localCfg.owner}/${localCfg.repo}`}>æ‰“å¼€ä»“åº“</a>
            </div>
          </div>
          <div className="bg-white/5 rounded-2xl p-4 border border-white/10">
            <div className="font-semibold mb-3">ç®¡ç†å‘˜ä»¤ç‰Œ (Personal Access Token)</div>
            <p className="text-sm text-white/70 mb-2">å»ºè®®ä½¿ç”¨ç»†ç²’åº¦ä»¤ç‰Œï¼ˆå¯¹ç›®æ ‡ä»“åº“æˆäºˆ Contents: Read &amp; Writeï¼‰ã€‚ä»¤ç‰Œåªä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ LocalStorageã€‚</p>
            <input type="password" className="w-full px-3 py-2 rounded-lg bgç™½/10 text-sm placeholderç™½/60 border borderç™½/20 focus:outline-none"
                   placeholder="github_pat_xxx æˆ– ghp_xxx" value={localToken} onChange={(e)=>setLocalToken(e.target.value)} />
            <div className="mt-3 flex gap-2">
              <button onClick={()=>setToken(localToken)} className="px-4 py-2 rounded-xl bg-amber-500 hover:bg-amber-400 text-sm">ä¿å­˜ä»¤ç‰Œ</button>
              <button onClick={()=>{setLocalToken(''); setToken('');}} className="px-4 py-2 rounded-xl bg-slate-600 hover:bg-slate-500 text-sm">æ¸…é™¤ä»¤ç‰Œ</button>
            </div>
          </div>
        </div>
      );
    }

    // ------------------ Admin Panel ------------------
    function AdminPanelV2({ cfg, token, onUploaded }){
      const [files, setFiles] = useState([]);
      const [title, setTitle] = useState('');
      const [topic, setTopic] = useState('');
      const [tags, setTags] = useState('');
      const [desc, setDesc] = useState('');
      const [cover, setCover] = useState(null);
      const [busy, setBusy] = useState(false);
      const [msg, setMsg] = useState('');

      function handleSelect(e){ setFiles(Array.from(e.target.files||[])); }
      function handleCover(e){ setCover((e.target.files||[])[0] || null); }

      async function uploadAll(){
        if (!token) { alert('è¯·å…ˆåœ¨ä¸Šæ–¹è®¾ç½®ç®¡ç†å‘˜ä»¤ç‰Œ (GitHub PAT)ã€‚'); return; }
        if (!files.length) { alert('è¯·é€‰æ‹©æ–‡ä»¶'); return; }
        setBusy(true); setMsg('');
        try {
          let indexData = await ghGetJSONRaw(cfg, cfg.indexPath);
          if (!indexData) indexData = { items: [] };
          const indexMeta = await ghGetContentMeta(cfg, cfg.indexPath, token);
          const indexSha = indexMeta?.sha;

          // ä¸Šä¼ å°é¢ï¼ˆå¦‚æœæœ‰ï¼‰
          const imagePath = await uploadCoverIfNeeded(cfg, token, cover, '');

          const y = new Date().getFullYear();
          const m = String(new Date().getMonth()+1).padStart(2,'0');
          const baseDir = `${cfg.dataDir}/${y}/${m}`;

          let i = 0;
          for (const file of files) {
            i += 1;
            setMsg(`æ­£åœ¨ä¸Šä¼  (${i}/${files.length})ï¼š${file.name}`);
            const buf = new Uint8Array(await file.arrayBuffer());
            const base64 = b64EncodeUint8(buf);
            const id = uid();
            const cleanTitle = title || file.name.replace(/\.[^/.]+$/, '');
            const kind = guessKind(file.name);
            const filename = `${id}__${file.name}`;
            const path = `${baseDir}/${filename}`;
            const meta = await ghGetContentMeta(cfg, path, token);
            await ghPutContent(cfg, path, base64, `Upload ${file.name} via Repo Library`, token, meta?.sha);

            indexData.items.push({
              id,
              title: cleanTitle,
              filename: file.name,
              path,
              kind,
              topic: topic || '',
              tags: tags ? tags.split(',').map(s=>s.trim()).filter(Boolean) : [],
              ts: Date.now(),
              size: file.size,
              desc: desc || '',
              imagePath: imagePath || '',
            });
          }

          const updated = new TextEncoder().encode(JSON.stringify(indexData, null, 2));
          const updatedB64 = b64EncodeUint8(new Uint8Array(updated));
          await ghPutContent(cfg, cfg.indexPath, updatedB64, `Update index.json (${files.length} items)`, token, indexSha);

          setMsg(`æˆåŠŸä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶ï¼Œå¹¶æ›´æ–°ç´¢å¼•ã€‚`);
          setFiles([]); setTitle(''); setTopic(''); setTags(''); setDesc(''); setCover(null);
          onUploaded && onUploaded();
        } catch(e) {
          console.error(e);
          setMsg('å‡ºé”™ï¼š' + e.message);
        } finally { setBusy(false); }
      }

      const fileCount = files.length;
      const fileNames = fileCount ? files.map(f=>f.name).join(', ') : 'æœªé€‰æ‹©æ–‡ä»¶';

      return (
        <section className="mb-6">
          <div className="bg-white rounded-3xl shadow-soft border border-slate-200 p-4">
            <div className="flex items-center justify-between mb-3">
              <div className="font-semibold text-slate-900">ä¸Šä¼ æ–°æ¡ç›®</div>
              <div className="text-xs text-slate-500">æ–‡ä»¶ä¼šæŒ‰å¹´æœˆè‡ªåŠ¨å­˜å…¥ï¼š{cfg.dataDir}/YYYY/MM</div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-3">
                <label className="text-sm block">
                  <div className="mb-1 text-slate-700">é€‰æ‹©æ–‡ä»¶ (æ”¯æŒå¤šé€‰)</div>
                  <input type="file" multiple onChange={handleSelect} className="block w-full text-sm" />
                  <div className="mt-1 text-xs text-slate-500 truncate">å½“å‰: {fileNames}</div>
                </label>
                <label className="text-sm block">
                  <div className="mb-1 text-slate-700">ç»Ÿä¸€æ ‡é¢˜ï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™ç”¨æ–‡ä»¶åï¼‰</div>
                  <input value={title} onChange={e=>setTitle(e.target.value)} className="w-full px-3 py-2 rounded-xl border border-slate-300 text-sm" />
                </label>
                <label className="text-sm block">
                  <div className="mb-1 text-slate-700">Topicï¼ˆå¦‚ï¼šMajorana, Skyrmion, Altermagnetï¼‰</div>
                  <input value={topic} onChange={e=>setTopic(e.target.value)} className="w-full px-3 py-2 rounded-xl border border-slate-300 text-sm" />
                </label>
                <label className="text-sm block">
                  <div className="mb-1 text-slate-700">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</div>
                  <input value={tags} onChange={e=>setTags(e.target.value)} className="w-full px-3 py-2 rounded-xl border border-slate-300 text-sm" />
                </label>
              </div>
              <div className="space-y-3">
                <label className="text-sm block">
                  <div className="mb-1 text-slate-700">æ¡ç›®ç®€è¦æè¿°</div>
                  <textarea value={desc} onChange={e=>setDesc(e.target.value)} rows={5} className="w-full px-3 py-2 rounded-xl border border-slate-300 text-sm" />
                </label>
                <label className="text-sm block">
                  <div className="mb-1 text-slate-700">å°é¢å›¾ï¼ˆå¯é€‰ï¼Œå»ºè®® 16:9 æˆ– 4:3ï¼‰</div>
                  <input type="file" accept="image/*" onChange={handleCover} className="block w-full text-sm" />
                </label>
              </div>
            </div>
            <div className="mt-4 flex items-center gap-3">
              <button
                onClick={uploadAll}
                disabled={busy}
                className={`px-4 py-2 rounded-2xl text-sm text-white ${busy ? 'bg-slate-400' : 'bg-slate-900 hover:bg-slate-800'}`}
              >
                {busy ? 'ä¸Šä¼ ä¸­â€¦' : 'ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶'}
              </button>
              {msg ? <div className="text-xs text-slate-600">{msg}</div> : null}
